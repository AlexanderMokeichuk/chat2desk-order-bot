# Shoro Chat2Desk Bot

–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–æ—Ç –¥–ª—è –ø—Ä–∏—ë–º–∞ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É –≤–æ–¥—ã Shoro —á–µ—Ä–µ–∑ Chat2Desk.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏—ë–º –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ —á–∞—Ç—ã (WhatsApp, Telegram, –∏ –¥—Ä.)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –æ—á–µ—Ä–µ–¥—è–º–∏
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ 300+ –∑–∞–∫–∞–∑–æ–≤ –≤ –¥–µ–Ω—å

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Bun 1.0+
- Docker & Docker Compose
- PostgreSQL 15+
- Redis 7+
- Chat2Desk –∞–∫–∫–∞—É–Ω—Ç —Å API —Ç–æ–∫–µ–Ω–æ–º

## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone <repository-url>
cd shoro-chat2desk-bot
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
bun install
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π .env –∏ –¥–æ–±–∞–≤—å —Å–≤–æ–π CHAT2DESK_API_TOKEN
```

### 4. –ó–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```bash
# –ó–∞–ø—É—Å–∫ Redis –∏ PostgreSQL
bun run docker:up
```

### 5. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1: Webhook —Å–µ—Ä–≤–µ—Ä
bun run dev:server

# –¢–µ—Ä–º–∏–Ω–∞–ª 2: Worker
bun run dev:worker
```

## üì¶ Production –¥–µ–ø–ª–æ–π

```bash
# –ë–∏–ª–¥ –ø—Ä–æ–µ–∫—Ç–∞
bun run build

# –ó–∞–ø—É—Å–∫
bun run start:server  # Webhook —Å–µ—Ä–≤–µ—Ä
bun run start:worker  # Worker
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Chat2Desk ‚Üí Webhook Server ‚Üí Redis Queue ‚Üí Workers ‚Üí PostgreSQL
                                  ‚Üì
                          State Management (Redis)
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

- **Webhook Server** - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç webhooks –æ—Ç Chat2Desk (Bun.serve)
- **Message Queue** - –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (Bull + Redis)
- **Workers** - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –¥–∏–∞–ª–æ–≥–æ–º (5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤)
- **State Management** - –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ (Redis, TTL 24—á)
- **PostgreSQL** - –•—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤

## üìù –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è            | –û–ø–∏—Å–∞–Ω–∏–µ             | –ü—Ä–∏–º–µ—Ä          |
|-----------------------|----------------------|-----------------|
| `PORT`                | –ü–æ—Ä—Ç webhook —Å–µ—Ä–≤–µ—Ä–∞ | `3000`          |
| `REDIS_HOST`          | –•–æ—Å—Ç Redis           | `localhost`     |
| `DATABASE_HOST`       | –•–æ—Å—Ç PostgreSQL      | `localhost`     |
| `DATABASE_NAME`       | –ò–º—è –ë–î               | `shoro_bot_dev` |
| `CHAT2DESK_API_TOKEN` | API —Ç–æ–∫–µ–Ω Chat2Desk  | `your_token`    |
| `WORKER_CONCURRENCY`  | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ workers | `5`             |
| `LOG_LEVEL`           | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–æ–≤        | `info`          |

–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫: —Å–º. `.env.example`

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
bun run dev:server      # –ó–∞–ø—É—Å–∫ webhook —Å–µ—Ä–≤–µ—Ä–∞
bun run dev:worker      # –ó–∞–ø—É—Å–∫ worker

# Production
bun run start:server    # –ó–∞–ø—É—Å–∫ prod —Å–µ—Ä–≤–µ—Ä–∞
bun run start:worker    # –ó–∞–ø—É—Å–∫ prod worker

# Docker
bun run docker:up       # –ó–∞–ø—É—Å–∫ Redis + PostgreSQL
bun run docker:down     # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
bun run docker:logs     # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
bun run docker:clean    # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (—É–¥–∞–ª–∏—Ç –¥–∞–Ω–Ω—ã–µ!)

# –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
bun run lint            # –ü—Ä–æ–≤–µ—Ä–∫–∞ ESLint
bun run format          # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Prettier
bun run test            # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```

## üìä Endpoints

### `POST /webhook/chat2desk`

–ü—Ä–∏—ë–º webhooks –æ—Ç Chat2Desk

**Request:**

```json
{
  "client_id": "client_123",
  "message_id": "msg_001",
  "text": "–ü—Ä–∏–≤–µ—Ç"
}
```

**Response:**

```json
{
  "success": true
}
```

### `GET /health`

–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞

**Response:**

```json
{
  "status": "healthy",
  "checks": {
    "redis": true,
    "postgres": true,
    "queues": {
      "message": 0,
      "outbox": 0
    }
  }
}
```

### `GET /`

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ config/           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (env, redis, database)
‚îú‚îÄ‚îÄ handlers/         # Dialog handler (–ª–æ–≥–∏–∫–∞ –¥–∏–∞–ª–æ–≥–∞)
‚îú‚îÄ‚îÄ queues/           # Bull –æ—á–µ—Ä–µ–¥–∏ (message, outbox)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ chat2desk/    # Chat2Desk API client
‚îÇ   ‚îú‚îÄ‚îÄ order/        # Order service + repository
‚îÇ   ‚îî‚îÄ‚îÄ state/        # State management
‚îú‚îÄ‚îÄ types/            # TypeScript —Ç–∏–ø—ã
‚îú‚îÄ‚îÄ utils/            # –£—Ç–∏–ª–∏—Ç—ã (logger)
‚îú‚îÄ‚îÄ validators/       # –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã (–∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
‚îú‚îÄ‚îÄ workers/          # Message worker
‚îú‚îÄ‚îÄ server.ts         # Webhook server entry point
‚îî‚îÄ‚îÄ worker.ts         # Worker entry point
```

## üîÑ –õ–æ–≥–∏–∫–∞ –¥–∏–∞–ª–æ–≥–∞

–ë–æ—Ç –≤–µ–¥—ë—Ç –¥–∏–∞–ª–æ–≥ –≤ 5 —ç—Ç–∞–ø–æ–≤:

1. **INITIAL** ‚Üí –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
2. **WAITING_ADDRESS** ‚Üí –ó–∞–ø—Ä–æ—Å –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
3. **WAITING_PHONE** ‚Üí –ó–∞–ø—Ä–æ—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
4. **WAITING_BOTTLES** ‚Üí –ó–∞–ø—Ä–æ—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±—É—Ç—ã–ª–µ–π (1-50)
5. **WAITING_CONFIRMATION** ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞

–ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–∫–∞–∑ –≤ –ë–î.

## üõ°Ô∏è –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

- **Retry –º–µ—Ö–∞–Ω–∏–∑–º** - 3 –ø–æ–ø—ã—Ç–∫–∏ —Å exponential backoff
- **Outbox Queue** - –Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –¥–æ 50 —Ä–∞–∑
- **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π —á–µ—Ä–µ–∑ Redis (7 –¥–Ω–µ–π)
- **State TTL** - —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –∞–≤—Ç–æ—É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
- **Graceful shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏ SIGTERM/SIGINT

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **Webhook response time:** 2-5ms
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:** ~200ms
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:** 60 msg/sec (300+ –∑–∞–∫–∞–∑–æ–≤/–¥–µ–Ω—å)
- **Concurrency:** 5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö workers (–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –¥–æ 50+)

## üêõ Troubleshooting

### –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

1. –ü—Ä–æ–≤–µ—Ä—å Chat2Desk API token –≤ `.env`
2. –ü—Ä–æ–≤–µ—Ä—å webhook URL –≤ Chat2Desk –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
3. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: `bun run docker:logs`

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis/PostgreSQL

```bash
# –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
docker ps

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏
bun run docker:down
bun run docker:up
```

### –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä—å —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
docker exec -it shoro-redis redis-cli
> LLEN bull:messages:wait

# –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ worker
bun run dev:worker
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [ARCHITECTURE.md](docs/ARCHITECTURE.md) - –î–µ—Ç–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- [DEVELOPMENT.md](docs/DEVELOPMENT.md) - –ì–∞–π–¥ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- [DEPLOYMENT.md](docs/DEPLOYMENT.md) - Production –¥–µ–ø–ª–æ–π

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## üë§ –ê–≤—Ç–æ—Ä

Alexander Mokeichuk - Frontend/Fullstack Developer @ Shoro